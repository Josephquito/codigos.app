<div class="min-h-screen bg-gray-100 px-4 py-8">
  <div class="max-w-7xl mx-auto space-y-8">
    <h1 class="text-4xl font-bold text-center text-gray-800">
      Administrar Cuentas
    </h1>

    <!-- Filtro de b√∫squeda -->
    <div class="flex justify-center">
      <label
        class="input input-bordered flex items-center gap-2 w-full max-w-md"
      >
        <svg
          class="w-5 h-5 text-gray-500"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <circle cx="11" cy="11" r="8" />
          <line x1="21" y1="21" x2="16.65" y2="16.65" />
        </svg>
        <input
          type="text"
          [(ngModel)]="filtroCorreo"
          (input)="buscarCorreo()"
          placeholder="Buscar correo..."
          class="grow"
        />
      </label>
    </div>

    <!-- Formulario para nueva cuenta -->
    <form
      (submit)="registrarCuenta()"
      class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center"
    >
      <input
        [(ngModel)]="nuevaCuenta.emailAlias"
        name="email"
        placeholder="Correo"
        class="input input-bordered w-full"
        required
      />
      <input
        [(ngModel)]="nuevaCuenta.clave"
        name="clave"
        placeholder="Clave de la plataforma"
        class="input input-bordered w-full"
        required
      />
      <select
        [(ngModel)]="nuevaCuenta.plataforma"
        name="plataforma"
        class="select select-bordered w-full"
        required
      >
        <option disabled selected value="">Plataforma</option>
        <option *ngFor="let p of plataformas" [value]="p">
          {{ p | titlecase }}
        </option>
      </select>
      <button
        type="submit"
        class="btn btn-neutral w-full"
        [disabled]="cargando"
      >
        Agregar
        <span
          *ngIf="cargando"
          class="loading loading-spinner loading-sm ml-2"
        ></span>
      </button>
    </form>

    <!-- Tabla de cuentas -->
    <div class="overflow-x-auto bg-white shadow-md rounded-xl p-4">
      <table class="table w-full">
        <thead>
          <tr class="text-base text-center text-gray-800">
            <th>#</th>
            <th>Correo</th>
            <th *ngFor="let plataforma of plataformas" class="capitalize">
              {{ plataforma }}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let cuenta of cuentas; let i = index"
            class="hover:bg-base-200 text-center"
          >
            <th>{{ i + 1 }}</th>

            <!-- Correo + bot√≥n eliminar -->
            <td class="text-left">
              <div class="flex flex-col">
                <span class="font-semibold">{{ cuenta.correo }}</span>
                <button
                  class="btn btn-outline btn-error btn-xs mt-1 w-fit"
                  (click)="eliminarCuentaCompleta(cuenta.correo)"
                >
                  Eliminar Cuenta
                </button>
              </div>
            </td>

            <!-- Columnas por plataforma -->
            <td *ngFor="let plataforma of plataformas">
              <div class="flex flex-col items-center gap-1">
                <!-- Clave o input -->
                <ng-container
                  *ngIf="editando[cuenta.correo]?.[plataforma]; else claveTexto"
                >
                  <input
                    [(ngModel)]="cuenta[plataforma]"
                    class="input input-sm input-bordered text-center w-32"
                    placeholder="Clave"
                  />
                </ng-container>

                <ng-template #claveTexto>
                  <ng-container
                    *ngIf="
                      cuenta[plataforma] !== 'Sin asignar';
                      else agregarBtn
                    "
                  >
                    <span class="font-medium text-gray-800">
                      {{ cuenta[plataforma] }}
                    </span>
                  </ng-container>

                  <ng-template #agregarBtn>
                    <button
                      class="btn btn-xs btn-outline btn-success"
                      (click)="editarUnico(cuenta.correo, plataforma)"
                    >
                      + Agregar
                    </button>
                  </ng-template>
                </ng-template>

                <!-- Botones de acci√≥n -->
                <div class="flex gap-1">
                  <!-- Solo mostrar ‚úèÔ∏è si tiene una clave -->
                  <button
                    *ngIf="cuenta[plataforma] !== 'Sin asignar' && !editando[cuenta.correo]?.[plataforma]"
                    class="btn btn-xs border border-gray-400 text-gray-700 hover:bg-gray-200"
                    (click)="editarUnico(cuenta.correo, plataforma)"
                  >
                    ‚úèÔ∏è
                  </button>

                  <!-- Bot√≥n eliminar clave si tiene clave -->
                  <button
                    *ngIf="cuenta[plataforma] !== 'Sin asignar'"
                    class="btn btn-xs btn-outline btn-error"
                    (click)="eliminarCuenta(cuenta.correo, plataforma)"
                  >
                    ‚úñ
                  </button>

                  <!-- Bot√≥n guardar visible solo cuando est√° en edici√≥n -->
                  <button
                    *ngIf="editando[cuenta.correo]?.[plataforma]"
                    class="btn btn-xs btn-success"
                    (click)="
                      guardarClave(
                        cuenta.correo,
                        plataforma,
                        cuenta[plataforma]
                      )
                    "
                  >
                    üíæ
                  </button>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
