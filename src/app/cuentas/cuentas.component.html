<div class="min-h-[calc(100vh-64px)] bg-gray-100 px-4 py-8">
  <div class="mx-auto w-full max-w-6xl space-y-4">
    <!-- Header -->
    <div
      class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between"
    >
      <div>
        <h1 class="text-3xl font-bold text-gray-800">Cuentas</h1>
        <p class="text-sm text-gray-600">
          Administra tus accesos para que tus clientes puedan consultar sus
          códigos.
        </p>
      </div>
    </div>

    <!-- Alerts -->
    <div
      *ngIf="errorMessage"
      class="p-3 rounded-md text-sm font-medium text-red-700 bg-red-100 border border-red-300"
    >
      {{ errorMessage }}
    </div>

    <div
      *ngIf="successMessage"
      class="p-3 rounded-md text-sm font-medium text-green-700 bg-green-100 border border-green-300"
    >
      {{ successMessage }}
    </div>

    <!-- Form: Crear -->
    <div class="bg-white rounded-lg shadow-md p-4 space-y-3">
      <h2 class="text-lg font-semibold text-gray-800">Agregar cuenta</h2>

      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
        <input
          class="input input-bordered w-full"
          type="email"
          placeholder="correo@dominio.com"
          [(ngModel)]="nuevaCuenta.emailAlias"
          name="emailAlias"
          [disabled]="cargando"
        />

        <select
          class="select select-bordered w-full"
          [(ngModel)]="nuevaCuenta.plataforma"
          name="plataforma"
          [disabled]="cargando"
        >
          <option value="" disabled>Selecciona plataforma</option>
          <option *ngFor="let p of plataformas" [value]="p">
            {{ p }}
          </option>
        </select>
        <div class="space-y-1">
          <label class="text-xs text-gray-500"
            >Clave para que los clientes consulten su codigo</label
          >
          <input
            class="input input-bordered w-full"
            type="text"
            placeholder="Clave"
            [(ngModel)]="nuevaCuenta.clave"
            name="clave"
            [disabled]="cargando"
          />
        </div>

        <div class="space-y-1">
          <label class="text-xs text-gray-500">
            Fecha programada para cambiar la clave
          </label>
          <input
            class="input input-bordered w-full"
            type="date"
            [(ngModel)]="nuevaCuenta.passwordChangeAt"
            name="passwordChangeAt"
            [disabled]="cargando"
          />
        </div>
      </div>

      <button
        class="btn btn-neutral w-full"
        (click)="registrarCuenta()"
        [disabled]="cargando"
      >
        <span *ngIf="!cargando">Guardar</span>
        <span *ngIf="cargando" class="flex items-center gap-2">
          Guardando...
          <span class="loading loading-spinner loading-md"></span>
        </span>
      </button>
    </div>

    <!-- Search -->
    <div class="bg-white rounded-lg shadow-md p-4">
      <div
        class="grid w-full gap-3 grid-cols-1 md:[grid-template-columns:1fr_280px_120px_120px]"
      >
        <!-- 1) Buscador -->
        <input
          type="text"
          class="input input-bordered w-full"
          placeholder="Buscar por correo, plataforma o id..."
          [(ngModel)]="filtro"
          (input)="aplicarFiltros()"
          [disabled]="cargando"
        />

        <!-- 2) Filtro por plataforma -->
        <select
          class="select select-bordered w-full"
          [(ngModel)]="filtroPlataforma"
          (change)="aplicarFiltros()"
          [disabled]="cargando"
        >
          <option value="">Todas las plataformas</option>
          <option *ngFor="let p of plataformas" [value]="p">{{ p }}</option>
        </select>

        <!-- 3) Botón HOY -->
        <button
          class="btn w-full"
          [ngClass]="soloHoy ? 'btn-neutral' : 'btn-outline'"
          (click)="toggleSoloHoy()"
          [disabled]="cargando"
          title="Mostrar solo cuentas cuyo cambio de clave es hoy"
        >
          HOY
          <span *ngIf="soloHoy" class="badge badge-ghost ml-2">
            {{ countHoy }}
          </span>
        </button>

        <!-- 4) Limpiar -->
        <button
          class="btn btn-ghost w-full"
          (click)="limpiarFiltros()"
          [disabled]="cargando"
          title="Limpiar filtros"
        >
          LIMPIAR
        </button>
      </div>

      <!-- Hint -->
      <div *ngIf="soloHoy" class="mt-2 text-xs text-gray-500">
        Mostrando cuentas cuyo cambio de clave está programado para hoy.
      </div>

      <!-- Total -->
      <div class="mt-2 text-sm text-gray-600">
        Total: <span class="font-semibold">{{ cuentas.length }}</span>
      </div>
    </div>

    <!-- Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
      <div class="overflow-x-auto">
        <table class="table w-full">
          <thead>
            <tr>
              <th>ID</th>
              <th>Plataforma</th>
              <th>Correo</th>
              <th>Clave</th>
              <th>Creación</th>
              <th>Cambio clave</th>
              <th>Días Restantes</th>
              <th class="text-right">Acciones</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngIf="cargando">
              <td colspan="8" class="py-10 text-center text-gray-600">
                <span class="inline-flex items-center gap-2">
                  <span class="loading loading-spinner loading-md"></span>
                  Cargando cuentas...
                </span>
              </td>
            </tr>

            <tr *ngIf="!cargando && cuentas.length === 0">
              <td colspan="8" class="py-10 text-center text-gray-600">
                No hay cuentas registradas.
              </td>
            </tr>

            <tr *ngFor="let c of cuentas">
              <td class="font-mono text-sm">{{ c.id }}</td>

              <td>
                <span class="badge badge-outline">{{ c.plataforma }}</span>
              </td>

              <td class="break-all">{{ c.emailAlias }}</td>

              <td class="break-all">{{ c.clave }}</td>

              <!-- Fechas: DD/MM/AA -->
              <td class="text-sm text-gray-600">
                {{ c.createdAt | date : "dd/MM/yy" : "UTC" }}
              </td>

              <td class="text-sm text-gray-600">
                {{ c.passwordChangeAt | date : "dd/MM/yy" : "UTC" }}
              </td>

              <!-- Días restantes (solo texto, sin badge) -->
              <td class="text-sm font-semibold">
                <ng-container [ngSwitch]="diasRestantes(c.passwordChangeAt)">
                  <!-- vencida -->
                  <span *ngSwitchCase="-1" class="text-red-600">Vencida</span>

                  <!-- si diasRestantes < 0 pero no exactamente -1 -->
                  <span
                    *ngSwitchDefault
                    [ngClass]="
                      diasRestantes(c.passwordChangeAt) < 0
                        ? 'text-red-600'
                        : diasRestantes(c.passwordChangeAt) === 0
                        ? 'text-yellow-600'
                        : 'text-green-600'
                    "
                  >
                    {{
                      diasRestantes(c.passwordChangeAt) < 0
                        ? "Vencida"
                        : diasRestantes(c.passwordChangeAt) === 0
                        ? "Vence hoy"
                        : "Faltan " +
                          diasRestantes(c.passwordChangeAt) +
                          " días"
                    }}
                  </span>
                </ng-container>
              </td>

              <!-- Acciones -->
              <td class="text-right">
                <div class="flex justify-end gap-2">
                  <!-- Edit abre modal -->
                  <button
                    class="btn btn-sm btn-outline"
                    (click)="abrirEditar(c)"
                    [disabled]="rowLoading.has(c.id) || cargando"
                    title="Editar"
                  >
                    Editar
                  </button>

                  <!-- Delete (ya lo tienes con confirm modal) -->
                  <button
                    class="btn btn-sm btn-error"
                    (click)="abrirConfirmEliminar(c)"
                    [disabled]="rowLoading.has(c.id) || cargando"
                    title="Eliminar"
                  >
                    <span *ngIf="!rowLoading.has(c.id)">Eliminar</span>
                    <span
                      *ngIf="rowLoading.has(c.id)"
                      class="flex items-center gap-2"
                    >
                      ...
                      <span class="loading loading-spinner loading-sm"></span>
                    </span>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal Editar -->
    <div *ngIf="editOpen" class="fixed inset-0 z-50">
      <div class="absolute inset-0 bg-black/40" (click)="cerrarEditar()"></div>

      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div
          class="w-full max-w-lg bg-white rounded-lg shadow-xl p-5 space-y-4"
        >
          <div class="flex items-start justify-between gap-4">
            <div>
              <h3 class="text-lg font-semibold text-gray-800">Editar cuenta</h3>
              <p class="text-xs text-gray-500">
                Actualiza la clave y la proxima fecha de cambio.
              </p>
            </div>

            <button class="btn btn-sm btn-ghost" (click)="cerrarEditar()">
              ✕
            </button>
          </div>

          <div class="rounded-md bg-gray-50 border p-3 text-sm space-y-1">
            <div>
              <span class="font-semibold">Plataforma:</span>
              {{ editTarget?.plataforma }}
            </div>
            <div>
              <span class="font-semibold">Correo:</span>
              {{ editTarget?.emailAlias }}
            </div>
          </div>

          <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
            <div class="sm:col-span-2">
              <label class="text-xs text-gray-500">Clave</label>
              <input
                class="input input-bordered w-full"
                type="text"
                [(ngModel)]="editForm.clave"
                [disabled]="savingEdit"
              />
            </div>

            <div class="sm:col-span-2">
              <label class="text-xs text-gray-500"
                >Fecha de cambio de clave</label
              >
              <input
                class="input input-bordered w-full"
                type="date"
                [(ngModel)]="editForm.passwordChangeAt"
                [disabled]="savingEdit"
              />
            </div>
          </div>

          <div class="flex justify-end gap-2 pt-2">
            <button
              class="btn btn-ghost"
              (click)="cerrarEditar()"
              [disabled]="savingEdit"
            >
              Cancelar
            </button>

            <button
              class="btn btn-neutral"
              (click)="guardarEditar()"
              [disabled]="savingEdit"
            >
              <span *ngIf="!savingEdit">Guardar</span>
              <span *ngIf="savingEdit" class="flex items-center gap-2">
                Guardando...
                <span class="loading loading-spinner loading-sm"></span>
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal confirm delete -->
    <div *ngIf="confirmOpen" class="fixed inset-0 z-50">
      <div
        class="absolute inset-0 bg-black/40"
        (click)="cancelarEliminar()"
      ></div>

      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div
          class="w-full max-w-md bg-white rounded-lg shadow-xl p-5 space-y-3"
        >
          <h3 class="text-lg font-semibold text-gray-800">
            Confirmar eliminación
          </h3>

          <p class="text-sm text-gray-600">
            ¿Estás seguro de que deseas eliminar esta cuenta?
          </p>

          <div class="rounded-md bg-gray-50 border p-3 text-sm space-y-1">
            <div>
              <span class="font-semibold">Correo:</span>
              {{ confirmTarget?.emailAlias }}
            </div>
            <div>
              <span class="font-semibold">Plataforma:</span>
              {{ confirmTarget?.plataforma }}
            </div>
            <div class="text-xs text-gray-500">
              Nota: Solo tus clientes perderan el acceso, tu aun puedes revisar
              sin clave.
            </div>
          </div>

          <div class="flex justify-end gap-2 pt-2">
            <button class="btn btn-ghost" (click)="cancelarEliminar()">
              Cancelar
            </button>

            <button
              class="btn btn-error"
              (click)="confirmarEliminar()"
              [disabled]="!!confirmTarget && rowLoading.has(confirmTarget.id)"
            >
              <span
                *ngIf="!(!!confirmTarget && rowLoading.has(confirmTarget.id))"
              >
                Aceptar
              </span>

              <span
                *ngIf="!!confirmTarget && rowLoading.has(confirmTarget.id)"
                class="flex items-center gap-2"
              >
                Eliminando...
                <span class="loading loading-spinner loading-sm"></span>
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
