<div class="page">
  <div class="header">
    <div>
      <h1 class="title">Clientes</h1>
      <p class="subtitle">Crear, editar y administrar clientes.</p>
    </div>

    <button
      class="btn btn-neutral"
      (click)="openCreate()"
      [disabled]="!canCreate"
      title="Requiere CUSTOMERS:CREATE"
    >
      Crear cliente
    </button>
  </div>

  <!-- Error -->
  <div *ngIf="errorMessage" class="alert alert-error">
    <span>{{ errorMessage }}</span>
  </div>

  <div class="card bg-base-100 shadow-sm">
    <div class="card-body">
      <!-- Loading -->
      <div *ngIf="loading" class="flex items-center gap-2">
        <span class="loading loading-spinner loading-md"></span>
        <span>Cargando clientes...</span>
      </div>

      <!-- Tabla -->
      <div *ngIf="!loading" class="overflow-x-auto">
        <table class="table table-zebra">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Contacto</th>
              <th>Origen</th>
              <th class="text-right">Acciones</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let c of customers">
              <td><div class="font-medium">{{ c.name }}</div></td>
              <td>{{ c.contact || '—' }}</td>
              <td>{{ c.source || '—' }}</td>

              <!-- Botón ⋮ -->
              <td class="text-right">
                <button
                  type="button"
                  class="btn btn-ghost btn-sm"
                  (click)="toggleMenu(c, $event)"
                  [disabled]="loadingRowId === c.id"
                  aria-label="Acciones"
                  title="Acciones"
                >
                  ⋮
                </button>
              </td>
            </tr>

            <tr *ngIf="customers.length === 0">
              <td colspan="4" class="text-center text-gray-500 py-6">
                No hay clientes registrados.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ✅ MENÚ FLOTANTE FIXED -->
  <div
    *ngIf="menuOpen && menuCustomer"
    class="fixed z-[99999]"
    [style.left.px]="menuX"
    [style.top.px]="menuY"
    style="transform: translateX(-100%)"
    (click)="$event.stopPropagation()"
  >
    <div class="bg-base-100 shadow rounded-box w-44 border border-base-200">
      <ul class="menu p-2">
        <li *ngIf="canUpdate">
          <button type="button" (click)="openEdit(menuCustomer); closeMenu()">
            Editar
          </button>
        </li>

        <li *ngIf="canDelete">
          <button
            type="button"
            class="text-error"
            (click)="confirmDelete(menuCustomer); closeMenu()"
          >
            Eliminar
          </button>
        </li>
      </ul>
    </div>
  </div>

  <!-- Modales -->
  <app-create-customer-modal
    [open]="createOpen"
    (close)="closeAll()"
    (created)="onCreated()"
  ></app-create-customer-modal>

  <app-edit-customer-modal
    [open]="editOpen"
    [customer]="selected"
    (close)="closeAll()"
    (updated)="onUpdated()"
  ></app-edit-customer-modal>

  <app-delete-customer-modal
    [open]="deleteOpen"
    [customer]="selected"
    (close)="closeAll()"
    (deleted)="onDeleted()"
  ></app-delete-customer-modal>
</div>
