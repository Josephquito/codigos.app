<dialog class="modal" [class.modal-open]="open">
  <div class="modal-box max-w-4xl relative">
    <div class="flex items-start justify-between gap-3">
      <div>
        <h3 class="font-bold text-lg">Perfiles de la cuenta</h3>
        <p class="text-sm opacity-70 mt-1">
          {{ account?.platform?.name || '—' }} · {{ account?.email || '—' }}
        </p>
      </div>

      <button class="btn btn-ghost" (click)="onClose()">✕</button>
    </div>

    <div *ngIf="errorMessage" class="alert alert-error mt-3">
      <span>{{ errorMessage }}</span>
    </div>

    <div class="mt-4">
      <div *ngIf="loading" class="flex items-center gap-2">
        <span class="loading loading-spinner loading-md"></span>
        <span>Cargando perfiles...</span>
      </div>

      <div *ngIf="!loading" class="overflow-x-auto" (click)="closeMenu()">
        <table class="table table-zebra">
          <thead>
            <tr>
              <th class="no-wrap">Perfil</th>
              <th class="no-wrap">Cliente</th>
              <th class="no-wrap">Fecha venta</th>
              <th class="no-wrap">Fecha corte</th>
              <th class="no-wrap">Alerta</th>
              <th class="no-wrap text-right">Acciones</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let p of (account?.profiles || [])">
              <td class="no-wrap font-mono">#{{ p.profileNo }}</td>

              <td
                class="no-wrap max-w-[220px]"
                [title]="getSaleForProfile(p)?.customer?.name || '—'"
              >
                <span class="font-medium">
                  {{ getSaleForProfile(p)?.customer?.name || '—' }}
                </span>
              </td>

              <td class="no-wrap text-sm text-gray-500">
                {{ getSaleForProfile(p)?.saleDate ?
                (getSaleForProfile(p)?.saleDate | date : 'mediumDate') : '—' }}
              </td>

              <td class="no-wrap text-sm text-gray-500">
                {{ getSaleForProfile(p)?.cutoffDate ?
                (getSaleForProfile(p)?.cutoffDate | date : 'mediumDate') : '—'
                }}
              </td>

              <td class="no-wrap">
                <ng-container
                  *ngIf="daysRemaining(getSaleForProfile(p)?.cutoffDate) as d; else noalert"
                >
                  <span class="badge" [ngClass]="alertBadgeClass(d)">
                    {{ d < 0 ? ('Hace ' + (d * -1) + ' días') : d === 0 ? 'Vence
                    hoy' : ('Queda ' + d + ' días') }}
                  </span>
                </ng-container>
                <ng-template #noalert>
                  <span class="badge badge-ghost">—</span>
                </ng-template>
              </td>

              <!-- Acciones -->
              <td class="no-wrap text-right" (click)="$event.stopPropagation()">
                <!-- AVAILABLE => botón vender centrado -->
                <div
                  *ngIf="p.status === 'AVAILABLE'; else soldActions"
                  class="flex justify-center"
                >
                  <button
                    class="btn btn-primary btn-sm"
                    *ngIf="canSell"
                    [disabled]="account?.status !== 'ACTIVE'"
                    (click)="openSell(p)"
                  >
                    Vender
                  </button>
                  <span *ngIf="!canSell" class="text-sm opacity-60"
                    >Sin permiso</span
                  >
                </div>

                <!-- SOLD/BLOCKED => ⋮ -->
                <ng-template #soldActions>
                  <button
                    type="button"
                    class="btn btn-ghost btn-sm"
                    (click)="toggleProfileMenu(p, $event)"
                    aria-label="Acciones"
                    title="Acciones"
                  >
                    ⋮
                  </button>
                </ng-template>
              </td>
            </tr>

            <tr *ngIf="(account?.profiles || []).length === 0">
              <td colspan="6" class="text-center text-gray-500 py-6">
                No hay perfiles.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ✅ MENÚ FLOTANTE DENTRO DEL MODAL (ABSOLUTE) -->
    <div
      *ngIf="menuOpen && menuProfile"
      class="absolute z-[999999]"
      [style.left.px]="menuX"
      [style.top.px]="menuY"
      style="transform: translateX(-100%)"
      (click)="$event.stopPropagation()"
    >
      <div class="bg-base-100 shadow rounded-box w-48 border border-base-200">
        <ul class="menu p-2">
          <li *ngIf="!canSell">
            <span class="opacity-70">Sin permiso</span>
          </li>

          <ng-container *ngIf="canSell">
            <li>
              <button
                type="button"
                (click)="onEditProfile(menuProfile!); closeMenu()"
              >
                Editar
              </button>
            </li>
            <li>
              <button
                type="button"
                (click)="onEmptyProfile(menuProfile!); closeMenu()"
              >
                Vaciar
              </button>
            </li>
          </ng-container>
        </ul>
      </div>
    </div>

    <div class="modal-action">
      <button class="btn" (click)="onClose()">Cerrar</button>
    </div>
  </div>

  <form method="dialog" class="modal-backdrop">
    <button (click)="onClose()">close</button>
  </form>

  <app-create-sale-modal
    [open]="createSaleOpen"
    [account]="account"
    [profile]="selectedProfile"
    (close)="createSaleOpen=false; selectedProfile=null"
    (created)="onSaleDone()"
  ></app-create-sale-modal>
</dialog>
